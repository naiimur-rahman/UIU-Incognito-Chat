<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>UIU Incognito Chat + AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #ff6600;
            --primary-dark: #e65c00;
            --bg-gradient: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-color: #333;
            --text-secondary: #666;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --chat-bg: rgba(255, 255, 255, 0.5);
            --msg-other-bg: #ffffff;
            --msg-other-text: #333;
            --input-bg: rgba(255,255,255,0.5);
            --status-green: #2ecc71;
            --verified-blue: #1da1f2;
            --admin-gold: #ffd700;
            --ai-color: #6c5ce7;
            --pin-bg: rgba(255, 245, 230, 0.95);
        }

        /* --- DARK MODE --- */
        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --glass-bg: rgba(22, 22, 27, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --primary: #ff8c00;
            --chat-bg: rgba(0, 0, 0, 0.3);
            --msg-other-bg: #2d2d3a;
            --msg-other-text: #e0e0e0;
            --input-bg: rgba(255, 255, 255, 0.08);
            --ai-color: #a29bfe;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --pin-bg: rgba(45, 45, 58, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        html, body {
            height: 100%; width: 100%; overflow: hidden; position: fixed; inset: 0; overscroll-behavior: none;
        }

        body {
            background: var(--bg-gradient);
            display: flex; flex-direction: column; color: var(--text-color); transition: background 0.5s ease;
        }

        /* --- ANIMATIONS --- */
        @keyframes popUp { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floatUp { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        
        .background-shape { position: absolute; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.6; pointer-events: none; }
        .shape-1 { width: 300px; height: 300px; background: #ffe259; top: -50px; left: -50px; }
        .shape-2 { width: 400px; height: 400px; background: #ffa751; bottom: -100px; right: -100px; }
        
        body.dark-mode .shape-1 { background: #4e54c8; opacity: 0.2; }
        body.dark-mode .shape-2 { background: #8f94fb; opacity: 0.2; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            position: relative; padding: 20px; animation: fadeIn 0.5s ease-out; overflow-y: auto;
        }

        .theme-toggle-container { position: absolute; top: 20px; right: 20px; z-index: 50; }

        .login-card {
            background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border);
            padding: 2.5rem 2rem; border-radius: 24px; box-shadow: var(--shadow); text-align: center;
            width: 100%; max-width: 380px; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 40px;
        }

        .logo-area { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .logo-icon { color: var(--primary); width: 48px; height: 48px; margin-bottom: 5px; }
        h1 { font-weight: 600; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem; }

        .input-group { position: relative; margin-bottom: 1.5rem; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); width: 18px; }
        
        input {
            width: 100%; padding: 14px 14px 14px 45px; border: 2px solid transparent; border-radius: 12px;
            background: rgba(0,0,0,0.05); font-size: 1rem; transition: 0.3s; outline: none; color: var(--text-color);
        }
        body.dark-mode input { background: rgba(255,255,255,0.1); }
        
        input:focus { background: rgba(255, 255, 255, 0.8); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 102, 0, 0.1); }
        body.dark-mode input:focus { background: rgba(255,255,255,0.15); }

        .primary-btn, .secondary-btn {
            width: 100%; padding: 14px; border-radius: 12px; border: none; cursor: pointer;
            font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s; font-size: 1rem;
        }
        .primary-btn { background: var(--primary); color: white; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3); }
        .primary-btn:active { transform: scale(0.98); }
        .secondary-btn { background: transparent; border: 2px solid var(--primary); color: var(--primary); text-decoration: none; }

        .login-footer {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            font-size: 0.8rem; color: var(--text-color); font-weight: 500; pointer-events: none; opacity: 0.8;
        }
        .login-footer a { color: var(--text-color); font-weight: 700; text-decoration: none; pointer-events: auto; }

        /* --- CHAT SCREEN --- */
        #chat-screen { 
            height: 100%; width: 100%; display: flex; flex-direction: column; 
            animation: fadeIn 0.5s ease-out; position: relative; 
        }

        .glass-header {
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0;
            border-bottom: 1px solid var(--glass-border);
        }
        .header-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 38px; height: 38px; background: rgba(255, 102, 0, 0.15); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        .header-text h2 { font-size: 1rem; margin-bottom: 0; }
        .active-count { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background-color: var(--status-green); box-shadow: 0 0 5px var(--status-green); }
        .header-controls { display: flex; gap: 5px; }

        /* --- PINNED MESSAGE BANNER --- */
        #pinned-banner {
            background: var(--pin-bg); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border); padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 18; cursor: pointer;
            animation: floatUp 0.3s ease;
        }
        .pinned-content { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .pin-icon { color: var(--primary); transform: rotate(45deg); flex-shrink: 0; }
        .pinned-text-area { display: flex; flex-direction: column; overflow: hidden; }
        .pinned-label { font-size: 0.65rem; color: var(--primary); font-weight: 700; text-transform: uppercase; }
        .pinned-text { font-size: 0.85rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unpin-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 5px; }

        .welcome-watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; width: 85%; pointer-events: none; z-index: 0; opacity: 0.6;
        }
        .welcome-icon-wrapper svg { width: 50px; height: 50px; stroke-width: 1.5px; opacity: 0.5; margin-bottom: 10px; color: var(--text-secondary);}
        .welcome-watermark p { color: var(--text-secondary); font-size: 0.95rem; font-weight: 500; opacity: 0.7; }
        .welcome-watermark .hint { font-size: 0.75rem; margin-top: 5px; opacity: 0.5; }

        #messages-container { 
            flex: 1; overflow-y: auto; padding: 15px; background: transparent; 
            display: flex; flex-direction: column; gap: 12px; z-index: 10; 
            scroll-behavior: smooth; overscroll-behavior-y: contain;
            overflow-x: hidden;
        }
        #messages-container::-webkit-scrollbar { width: 4px; }
        #messages-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        body.dark-mode #messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        .message-wrapper { width: 100%; display: flex; flex-direction: column; position: relative; transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        
        .message { 
            padding: 10px 14px; border-radius: 14px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; 
            animation: popUp 0.3s ease; position: relative; z-index: 11;
            /* FIXED: ALLOW TEXT SELECTION FOR COPYING */
            user-select: text !important; 
            touch-action: pan-y;
        }

        .my-message { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        
        .other-message { 
            align-self: flex-start; 
            background: var(--msg-other-bg); 
            color: var(--msg-other-text); 
            border-bottom-left-radius: 2px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        /* AI Message */
        .message.ai-message {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.25);
        }
        
        /* Admin Special */
        .message.admin-special { border: 2px solid var(--admin-gold); box-shadow: 0 0 8px rgba(255, 215, 0, 0.4); }
        .verified-badge { display: inline-flex; vertical-align: middle; margin-left: 4px; color: var(--verified-blue); }

        /* Deleted Message */
        .message.deleted-message {
            background-color: #f0f0f0; color: #888; font-style: italic;
            border: 1px solid #ddd; box-shadow: none; background: rgba(0,0,0,0.05);
            user-select: none !important;
        }
        body.dark-mode .message.deleted-message { background-color: rgba(255,255,255,0.05); color: #aaa; border: 1px solid #444; }

        /* Admin Delete Button */
        .admin-delete-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: #ff4757; color: white; border: none; border-radius: 50%;
            width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 15; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .delete-left { left: -32px; }
        .delete-right { right: -32px; }

        .meta { font-size: 0.7rem; margin-bottom: 3px; opacity: 0.8; font-weight: 600; display: flex; align-items: center; user-select: none; }

        /* --- REACTIONS --- */
        .reaction-menu {
            position: absolute; top: -45px; background: white; padding: 5px 8px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; gap: 8px; z-index: 100;
            animation: floatUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0,0,0,0.05); align-items: center;
        }
        body.dark-mode .reaction-menu { background: #2d2d3a; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        .reaction-option { font-size: 1.2rem; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .reaction-option:hover { transform: scale(1.3); }

        .reaction-display-bubble {
            position: absolute; bottom: -12px; background: white; border-radius: 12px; padding: 2px 6px; 
            font-size: 0.75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; gap: 2px; align-items: center; z-index: 12; border: 2px solid var(--chat-bg);
            user-select: none;
        }
        body.dark-mode .reaction-display-bubble { background: #3a3a4a; color: white; border-color: #222; }
        
        .my-message + .reaction-display-bubble { right: 0; }
        .other-message + .reaction-display-bubble { left: 0; }

        /* --- INPUT AREA & AI & REPLY --- */
        .input-area {
            padding: 15px; background: var(--glass-bg); display: flex; flex-direction: column; 
            backdrop-filter: blur(10px); position: relative; z-index: 20;
            padding-bottom: max(15px, env(safe-area-inset-bottom)); flex-shrink: 0;
            border-top: 1px solid var(--glass-border);
        }

        .input-wrapper { display: flex; width: 100%; gap: 8px; align-items: center; }

        .input-area input { 
            background: var(--input-bg); 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); 
            flex: 1; 
            font-size: 16px;
            padding-left: 15px; 
            color: var(--text-color);
        }
        .input-area input::placeholder { color: var(--text-secondary); }
        
        .send-btn {
            background: var(--primary); color: white; border: none; width: 44px; height: 44px;
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(255, 102, 0, 0.3); flex-shrink: 0;
        }
        .send-btn:active { transform: scale(0.95); }

        .chat-footer {
            width: 100%; text-align: center; font-size: 0.75rem; color: var(--text-color); font-weight: 500; opacity: 0.6; 
            margin-top: 8px; pointer-events: none;
        }

        /* AI Button */
        .ai-trigger {
            background: rgba(108, 92, 231, 0.1); color: var(--ai-color); border-radius: 12px;
            width: 44px; height: 44px; flex-shrink: 0; border: 1px solid rgba(108, 92, 231, 0.2);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .ai-trigger:active { transform: scale(0.95); }

        /* EMOJI Button */
        .emoji-trigger {
            background: rgba(0,0,0,0.05); color: #f39c12; border-radius: 12px;
            width: 44px; height: 44px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        body.dark-mode .emoji-trigger { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .emoji-trigger:active { transform: scale(0.95); }

        /* Emoji Picker Popover */
        .emoji-picker {
            position: absolute; bottom: 85px; left: 15px; width: 280px; height: 200px;
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border-radius: 16px; border: 1px solid var(--glass-border);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: grid; grid-template-columns: repeat(6, 1fr);
            padding: 10px; gap: 5px; overflow-y: auto; z-index: 100;
            animation: floatUp 0.2s ease;
        }
        .emoji-item {
            font-size: 1.5rem; cursor: pointer; text-align: center; padding: 5px;
            border-radius: 8px; transition: background 0.2s; user-select: none;
        }
        .emoji-item:hover { background: rgba(0,0,0,0.1); }
        body.dark-mode .emoji-item:hover { background: rgba(255,255,255,0.1); }

        /* Reply Preview Banner */
        .reply-preview {
            position: absolute; bottom: 100%; left: 0; width: 100%;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center; z-index: 15;
            animation: floatUp 0.2s ease;
        }
        .reply-content { border-left: 3px solid var(--primary); padding-left: 10px; flex: 1; overflow: hidden; }
        .reply-to-name { font-size: 0.75rem; color: var(--primary); font-weight: 600; display: block; }
        .reply-text { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Message Reply Quote */
        .reply-quote-block {
            background: rgba(0,0,0,0.05); border-left: 3px solid var(--primary);
            padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; font-size: 0.8rem; cursor: pointer; opacity: 0.8;
            color: var(--text-color);
        }
        body.dark-mode .reply-quote-block { background: rgba(255,255,255,0.08); }

        .my-message .reply-quote-block { background: rgba(255,255,255,0.2); border-color: white; color: white; }
        .reply-quote-name { font-weight: 600; font-size: 0.7rem; margin-bottom: 2px; }

        /* Reply Option in Menu */
        .reply-option-btn, .pin-option-btn { font-size: 1rem; padding: 0 5px; cursor: pointer; display: flex; align-items: center; color: var(--text-color); }
        body.dark-mode .reply-option-btn, body.dark-mode .pin-option-btn { color: white; }

        .hidden { display: none !important; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 8px; border-radius: 50%; transition: background 0.2s; display: flex; align-items: center; justify-content: center; }
        
        @media (max-width: 480px) {
            .login-card { padding: 2rem 1.5rem; width: 90%; }
            .message { font-size: 0.9rem; }
            .welcome-watermark { width: 90%; }
            .admin-delete-btn { opacity: 1 !important; } 
            .emoji-picker { width: 90%; left: 5%; bottom: 85px; }
        }
    </style>
</head>
<body>

    <div class="background-shape shape-1"></div>
    <div class="background-shape shape-2"></div>

    <div id="login-screen">
        <div class="theme-toggle-container">
            <button id="theme-toggle-login" class="icon-btn" aria-label="Toggle Theme">
                <i data-lucide="moon"></i>
            </button>
        </div>
        
        <div class="login-card">
            <div class="logo-area">
                <i data-lucide="message-circle" class="logo-icon"></i>
                <h1>UIU Chat</h1>
            </div>
            <p class="subtitle">Anonymous Student Community</p>
            
            <div class="input-group">
                <i data-lucide="user" class="input-icon"></i>
                <input type="text" id="username-input" placeholder="Enter your name..." maxlength="20" autocomplete="off">
            </div>

            <button id="join-btn" class="primary-btn">
                <span>Join Chat</span>
                <i data-lucide="arrow-right" style="width: 18px;"></i>
            </button>

            <a href="https://naiimur-rahman.github.io/UIU-CGPA-Calculator/" target="_blank" class="secondary-btn">
                <i data-lucide="calculator" style="width: 18px;"></i> 
                CGPA Calculator
            </a>
        </div>

        <div class="login-footer">
            Developed by <a href="https://www.facebook.com/naiimurr/" target="_blank">Naimur Rahman</a> (CSE 242) for UIU â¤ï¸ï¸
        </div>
    </div>

    <div id="chat-screen" class="hidden">
        <header class="glass-header">
            <div class="header-info">
                <div class="avatar">
                    <i data-lucide="graduation-cap"></i>
                </div>
                <div class="header-text">
                    <h2>UIU Community</h2>
                    <span class="active-count">
                        <span class="status-dot"></span> 
                        <span id="active-users-text">Connecting...</span>
                    </span>
                </div>
            </div>
            <div class="header-controls">
                <button id="theme-toggle-chat" class="icon-btn">
                    <i data-lucide="moon"></i>
                </button>
                <button id="logout-btn" class="icon-btn danger" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </header>

        <div id="pinned-banner" class="hidden">
            <div class="pinned-content">
                <div class="pin-icon"><i data-lucide="pin" style="width: 16px;"></i></div>
                <div class="pinned-text-area">
                    <span class="pinned-label">Pinned Message</span>
                    <span id="pinned-msg-text" class="pinned-text">Loading...</span>
                </div>
            </div>
            <button id="unpin-btn" class="unpin-btn hidden"><i data-lucide="x" style="width: 16px;"></i></button>
        </div>

        <div class="welcome-watermark">
            <div class="welcome-icon-wrapper">
                <i data-lucide="sparkles"></i>
            </div>
            <p>Be kind, stay curious.</p>
            <p class="hint">
                Click <b>ğŸ¤– Bot Icon</b> for AI Help.<br>
                Swipe Right â¡ï¸ to Reply.
            </p>
        </div>

        <div id="messages-container">
        </div>

        <div class="input-area">
            <div id="reply-preview" class="reply-preview hidden">
                <div class="reply-content">
                    <span class="reply-to-name">Replying to...</span>
                    <p class="reply-text">Message text...</p>
                </div>
                <button id="close-reply" class="icon-btn"><i data-lucide="x"></i></button>
            </div>
            
            <div id="emoji-picker" class="emoji-picker hidden"></div>

            <div class="input-wrapper">
                <button id="ai-trigger-btn" class="icon-btn ai-trigger" title="Ask AI">
                    <i data-lucide="bot"></i>
                </button>

                <button id="emoji-btn" class="icon-btn emoji-trigger" title="Emojis">
                    <i data-lucide="smile"></i>
                </button>

                <input type="text" id="message-input" placeholder="@ai or (Click ğŸ¤– to ask BhodAi)" autocomplete="off">
                
                <button id="send-btn" class="send-btn">
                    <i data-lucide="send" style="width: 20px;"></i>
                </button>
            </div>
            <div class="chat-footer">
                Developed by Naimur Rahman (CSE 242) â¤ï¸
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBx260kRaZe010DhaTxD7vPHER1ZIcQuxI",
            authDomain: "uiu-incognito-chat.firebaseapp.com",
            databaseURL: "https://uiu-incognito-chat-default-rtdb.firebaseio.com",
            projectId: "uiu-incognito-chat",
            storageBucket: "uiu-incognito-chat.firebasestorage.app",
            messagingSenderId: "579619680960",
            appId: "1:579619680960:web:11c11c4813eba3422cb325",
            measurementId: "G-B2RGV7N5JX"
        };

        // ğŸ”¥ GEMINI API SETUP (MULTI-KEY ROTATION + SPLIT TO AVOID SCANNING)
        // Format: ["FirstPart", "SecondPart"] -> Joins at runtime
        const API_KEY_PARTS = [
            ["AIzaSyC_WOMJ9J_", "mRxWFmGGHyVbR8D8fh72r7d8"], // Key 1
            ["AIzaSyDSStQu9xs-", "kHkEK1QeT96ONTq4d9kdDp0"], // Key 2
            ["AIzaSyA__0c2WDC7_", "xeSDWrF5VFLxZCJeiMv4sE"], // Key 3
            ["AIzaSyAPmYu6PCEy", "pKBI3QGClVH4EQM_XqZAK7c"], // Key 4
            ["AIzaSyDoVxvtxCGPA", "kr_rTJbLmrmGL3J6u3R9F0"], // Key 5
            ["AIzaSyCIj8vAM_u7", "UlmV0DkkhOqdDJ1td7sHT5o"], // Key 6
            ["AIzaSyCgRFOmpCSw", "Jut8YUL-MSqQkN5x39BzegA"], // Key 7
            ["AIzaSyDdw4sgr9An", "PF1q44FA6qtxUDqcpuMRaNI"], // Key 8
            ["AIzaSyCOzbUrQFNh", "mbWyCgnMl6RXEjuPyoD7qCI"], // Key 9
            ["AIzaSyBrlbSS-txX", "lTbzaM0Gde_lIriNpQdThms"]  // Key 10
        ];

        let currentKeyIndex = 0; // Starts with the first key
        
        const BOT_ID = "ai-system-bot-v1";
        
        // ğŸ”’ ADMIN SETUP (Plain Text Comparison)
        const ADMIN_PASSWORD = "0112420186"; 
        
        // âœ… RESTRICTED NAMES (These require the ADMIN_PASSWORD)
        const RESTRICTED_NAMES = ['naimur rahman', 'naimur rahma', 'naimur', 'admin', 'uiu bot', 'ai'];

        // --- 2. INITIALIZATION ---
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const usernameInput = document.getElementById('username-input');
        const joinBtn = document.getElementById('join-btn');
        const activeUsersText = document.getElementById('active-users-text');
        const logoutBtn = document.getElementById('logout-btn');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const themeToggleLogin = document.getElementById('theme-toggle-login');
        const themeToggleChat = document.getElementById('theme-toggle-chat');

        const replyPreview = document.getElementById('reply-preview');
        const closeReplyBtn = document.getElementById('close-reply');
        const aiTriggerBtn = document.getElementById('ai-trigger-btn');
        const replyToName = document.querySelector('.reply-to-name');
        const replyTextDisplay = document.querySelector('.reply-text');
        
        // New UI Elements
        const pinnedBanner = document.getElementById('pinned-banner');
        const pinnedMsgText = document.getElementById('pinned-msg-text');
        const unpinBtn = document.getElementById('unpin-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');

        let username = '';
        let myUUID = ''; 
        let database = null;
        let currentReply = null;
        const MAX_MESSAGES = 500;
        
        const REACTION_OPTIONS = ['â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ‘'];
        
        // Emoji List
        const EMOJI_LIST = [
            'ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡',
            'ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜™','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘',
            'ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬',
            'ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ',
            'ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸',
            'ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±',
            'ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿',
            'ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ‘‹','ğŸ¤š','ğŸ–',
            'âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•',
            'ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤',
            'ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','ğŸ¦µ','ğŸ¦¶','ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ§ ',
            'ğŸ¦·','ğŸ¦´','ğŸ‘€','ğŸ‘','ğŸ‘…','ğŸ‘„','ğŸ’‹','ğŸ©¸'
        ];

        if (typeof lucide !== 'undefined') lucide.createIcons();

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon(true);
            } else {
                updateThemeIcon(false);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const iconName = isDark ? 'sun' : 'moon';
            if (themeToggleLogin) themeToggleLogin.innerHTML = `<i data-lucide="${iconName}"></i>`;
            if (themeToggleChat) themeToggleChat.innerHTML = `<i data-lucide="${iconName}"></i>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.error("Firebase SDK not loaded.");
                return;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const activeUsersRef = database.ref('active_users');
                activeUsersRef.on('value', (snapshot) => {
                    const count = snapshot.exists() ? snapshot.numChildren() : 0;
                    if (activeUsersText) {
                        activeUsersText.innerText = `${count} Online`;
                    }
                });
                
                // Initialize Pin Listener
                initPinListener();
                
            } catch (error) { console.error("Firebase Init Error:", error); }
        }

        initTheme();
        initFirebase();
        initEmojiPicker();

        // --- 3. EVENT LISTENERS ---
        if (themeToggleLogin) themeToggleLogin.addEventListener('click', toggleTheme);
        if (themeToggleChat) themeToggleChat.addEventListener('click', toggleTheme);
        if (joinBtn) joinBtn.addEventListener('click', joinChat);
        if (usernameInput) usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinChat(); });
        
        if (sendBtn) sendBtn.addEventListener('click', () => sendMessage());
        if (messageInput) messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        if(aiTriggerBtn) aiTriggerBtn.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if(!text) { alert("Type something to ask AI!"); return; }
            sendMessage(true);
        });

        if(closeReplyBtn) closeReplyBtn.addEventListener('click', cancelReply);
        
        // Emoji Toggle
        if(emojiBtn) {
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPicker.classList.toggle('hidden');
            });
        }
        
        // Close Emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if(emojiPicker && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                emojiPicker.classList.add('hidden');
            }
        });
        
        // Unpin Listener
        if(unpinBtn) {
            unpinBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("Unpin this message?")) {
                    database.ref('pinned_message').remove();
                }
            });
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if(username && database) {
                    const userKey = username.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    database.ref('active_users/' + userKey).remove()
                    .then(() => { location.reload(); })
                    .catch(() => { location.reload(); });
                } else {
                    location.reload();
                }
            });
        }

        function generateUUID() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function initEmojiPicker() {
            if(!emojiPicker) return;
            EMOJI_LIST.forEach(emoji => {
                const span = document.createElement('div');
                span.className = 'emoji-item';
                span.innerText = emoji;
                span.onclick = () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                    emojiPicker.classList.add('hidden');
                };
                emojiPicker.appendChild(span);
            });
        }

        // --- PIN LOGIC ---
        // --- PIN LOGIC (UPDATED FIX) ---
        function initPinListener() {
            if(!database) return;
            database.ref('pinned_message').on('value', (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    pinnedBanner.classList.remove('hidden');
                    pinnedMsgText.innerText = `${data.author}: ${data.text}`;
                    
                    // Allow clicking to scroll to message
                    pinnedBanner.onclick = (e) => {
                         if(e.target !== unpinBtn && !unpinBtn.contains(e.target)) {
                             const original = document.getElementById(`msg-${data.id}`);
                             
                             if(original) {
                                 // âœ… FIX: Manual Scroll (à¦ªà§à¦°à§‹ à¦ªà§‡à¦œ à¦¨à§œà¦¬à§‡ à¦¨à¦¾, à¦¶à§à¦§à§ à¦šà§à¦¯à¦¾à¦Ÿ à¦¬à¦•à§à¦¸ à¦¸à§à¦•à§à¦°à¦² à¦¹à¦¬à§‡)
                                 const container = document.getElementById('messages-container');
                                 
                                 // à¦…à¦‚à¦• à¦•à¦°à§‡ à¦ªà¦œà¦¿à¦¶à¦¨ à¦¬à§‡à¦° à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡ à¦¯à¦¾à¦¤à§‡ à¦®à§‡à¦¸à§‡à¦œà¦Ÿà¦¾ à¦®à¦¾à¦à¦–à¦¾à¦¨à§‡ à¦†à¦¸à§‡
                                 const targetPosition = original.offsetTop - container.offsetTop - (container.clientHeight / 2) + (original.clientHeight / 2);
                                 
                                 container.scrollTo({
                                     top: targetPosition,
                                     behavior: 'smooth'
                                 });

                                 // à¦à¦•à¦Ÿà§ à¦à¦¨à¦¿à¦®à§‡à¦¶à¦¨ à¦¯à¦¾à¦¤à§‡ à¦‡à¦‰à¦œà¦¾à¦° à¦¬à§‹à¦à§‡ à¦•à§‹à¦¨ à¦®à§‡à¦¸à§‡à¦œà¦Ÿà¦¾
                                 const bubble = original.querySelector('.message');
                                 bubble.style.transition = "box-shadow 0.3s, transform 0.3s";
                                 bubble.style.boxShadow = "0 0 20px var(--primary)";
                                 bubble.style.transform = "scale(1.02)";
                                 
                                 setTimeout(() => {
                                     bubble.style.boxShadow = "0 2px 5px rgba(0,0,0,0.05)";
                                     bubble.style.transform = "scale(1)";
                                 }, 1000);

                             } else {
                                 alert("Message is too old or not currently loaded.");
                             }
                         }
                    };

                    // Only Naimur can unpin
                    if(username.toLowerCase() === 'naimur rahman') {
                        unpinBtn.classList.remove('hidden');
                    } else {
                        unpinBtn.classList.add('hidden');
                    }
                } else {
                    pinnedBanner.classList.add('hidden');
                }
            });
        }

        function pinMessage(msgId, text, author) {
            if(!database) return;
            if(confirm("Pin this message to the top?")) {
                database.ref('pinned_message').set({
                    id: msgId,
                    text: text,
                    author: author,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // --- JOIN LOGIC (SYNCHRONOUS CHECK) ---
        function joinChat() {
            if (!database) { alert("Connecting to server... Please check your internet."); return; }
            
            const rawName = usernameInput.value.trim();
            if (!rawName) { alert("Please enter your name."); return; }
            if (/[.#$\[\]]/.test(rawName)) { alert("Name cannot contain special characters."); return; }

            // Admin Password Check
            if (RESTRICTED_NAMES.includes(rawName.toLowerCase())) {
                const password = prompt(`The username "${rawName}" is reserved. Please enter the password:`);
                if (!password) return; 

                if (password !== ADMIN_PASSWORD) {
                    alert("Access Denied: Incorrect Password.");
                    return;
                }
            }

            const userKey = rawName.toLowerCase().replace(/[^a-z0-9]/g, '_'); 
            const userRef = database.ref('active_users/' + userKey);
            
            userRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    alert(`The name "${rawName}" is currently online! Please choose another.`);
                } else {
                    username = rawName;
                    myUUID = generateUUID(); 
                    
                    userRef.set({
                        originalName: username, 
                        status: "online",
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    userRef.onDisconnect().remove();
                    loginScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    loadMessages();
                    
                    // Re-check unpin button visibility after login
                    if(username.toLowerCase() === 'naimur rahman') {
                        unpinBtn.classList.remove('hidden');
                    }
                }
            });
        }

        // --- AI LOGIC (MULTI-KEY ROTATION + SPLIT FIX) ---
        async function askGemini(currentQuery) {
            
            // 1. Chat Context Creation
            let chatHistory = "Recent Chat Context:\n";
            const messages = document.querySelectorAll('.message-wrapper');
            const lastMessages = Array.from(messages).slice(-10); 

            lastMessages.forEach(msgWrapper => {
                const nameEl = msgWrapper.querySelector('.meta');
                const textEl = msgWrapper.querySelector('.text');
                if (nameEl && textEl) {
                    let name = nameEl.innerText.split('â€¢')[0].trim();
                    let text = textEl.innerText;
                    chatHistory += `${name}: ${text}\n`;
                }
            });

            const systemInstruction = `
            Identity: You are 'BhodAi', a witty, sarcastic, Bangladeshi student.
            
            Current Task: Reply to the "Current User Query" based on the "Recent Chat Context"(if context is same). Don't roast/bully in every text.
            
            CRITICAL RULES (Follow Strictness Level: MAX):
            1. NEVER repeat the same phrase or roast twice in a row.
            2. Keep replies SHORT (Max 30 words).
            3. Language: Mix of Bangla (in English script) and English. Use emojis.
            4. Specific Triggers:
                - If topic is University -> tell about UIU struggle.
                - If topic is love/relationship -> Roast about being single/engineering student fate.
                - If user asks/tell for something -> Do it immediately and answer politely.
            
            IMPORTANT EXCEPTIONS:
            - If topic is serious/sad/emotional -> Don't bully, be supportive.
            - If asked about creator/developer -> Naimur Rahman
            - If topic is about cgpa/gpa down -> Tell about Naimur Rahman's CGPA Calculator.
                Features-> Calculate trimester GPA and updated CGPA using your course list and grades.
                           Recalculate results for retaken courses by entering old and new grades.
                           Use a Target CGPA Planner to see what GPA you need next trimester to reach a goal CGPA.
                           Track course marks through a Course Grade Calculator.
                           Monitor your completed and remaining credits with a built-in Credit Tracker.
            
            ${chatHistory}
            
            Current User Query: ${currentQuery}
            Your Reply (Be unique & savage):`;

            // 3. MAIN LOGIC: KEY ROTATION LOOP
            let aiResponse = "Matha hang korse mama... Server limit sesh! ğŸ˜µâ€ğŸ’« Naimur vai ke janan.";
            let success = false;
            let attempts = 0;
            const MAX_ATTEMPTS = API_KEY_PARTS.length; 

            while (attempts < MAX_ATTEMPTS && !success) {
                try {
                    // ğŸ”¥ JOIN THE SPLIT KEY PARTS HERE
                    const currentKey = API_KEY_PARTS[currentKeyIndex].join("");
                    
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${currentKey}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemInstruction }] }]
                        })
                    });

                    // --- Error Handling & Rotation ---
                    if (!response.ok) {
                        // Switch on 429 (Too Many Requests)
                        if (response.status === 429) {
                            console.warn(`Key #${currentKeyIndex} limit over (429). Switching...`);
                            currentKeyIndex = (currentKeyIndex + 1) % MAX_ATTEMPTS; 
                            attempts++;
                            continue; // Try next key immediately
                        } else {
                            // Break loop on other errors (e.g., 400, 500)
                            console.error(`API Error Status: ${response.status}`);
                            break; 
                        }
                    }

                    // --- Success ---
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        aiResponse = data.candidates[0].content.parts[0].text;
                        success = true; 
                    } else {
                        // Empty response -> Try next key
                        attempts++;
                        currentKeyIndex = (currentKeyIndex + 1) % MAX_ATTEMPTS;
                    }

                } catch (error) {
                    console.error("Network Error, trying next key:", error);
                    currentKeyIndex = (currentKeyIndex + 1) % MAX_ATTEMPTS;
                    attempts++;
                }
            }

            // 4. Send Message to Firebase
            database.ref('messages').push({
                username: "BhodAi ğŸ¤–",
                text: aiResponse,
                senderId: BOT_ID, 
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isDeleted: false
            });
        }

        function sendMessage(isDirectAI = false) {
            const text = messageInput.value.trim();
            if (!database || !text) return;

            // Check if replying to bot
            const isReplyingToBot = currentReply && currentReply.username === "BhodAi ğŸ¤–";
            const isAiRequest = isDirectAI || text.toLowerCase().startsWith('@ai') || text.toLowerCase().startsWith('/ai') || isReplyingToBot;
            
            const msgData = {
                username: username,
                text: text,
                senderId: myUUID,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isDeleted: false
            };

            if (currentReply) {
                msgData.replyTo = {
                    id: currentReply.id,
                    username: currentReply.username,
                    text: currentReply.text
                };
            }

            database.ref('messages').push(msgData).then(() => { 
                messageInput.value = ''; 
                cancelReply();
                
                if (isAiRequest) {
                    let query = text.replace(/^(@ai|\/ai)\s*/i, '');
                    if(query.trim() === '') query = text; 
                    setTimeout(() => askGemini(query), 500);
                }
            }).catch(error => console.error(error));
        }

        // --- DELETION LOGIC (FINAL FIX) ---
        function deleteMessage(msgId) {
            if(confirm("Delete this message permanently?")) {
                database.ref('messages/' + msgId).update({
                    text: "ğŸš« Admin deleted message",
                    isDeleted: true,
                    replyTo: null,
                    username: "Unknown" 
                }).catch(error => {
                    console.error("Error deleting message:", error);
                    alert("Error deleting message: " + error.message);
                });
            }
        }

        function loadMessages() {
            if (!database) return;
            const messagesRef = database.ref('messages');
            
            messagesRef.limitToLast(MAX_MESSAGES).on('child_added', (snapshot) => {
                const data = snapshot.val();
                const msgId = snapshot.key; 
                if (data) { 
                    displayMessage(msgId, data.username, data.text, data.timestamp, data.senderId, data.isDeleted, data.replyTo); 
                    scrollToBottom(); 
                }
            });

            messagesRef.limitToLast(MAX_MESSAGES).on('child_changed', (snapshot) => {
                const data = snapshot.val();
                const msgId = snapshot.key;
                
                if(data.reactions) updateReactions(msgId, data.reactions);

                const msgEl = document.getElementById(`msg-${msgId}`);
                if (msgEl) {
                    const bubble = msgEl.querySelector('.message');
                    if (data.isDeleted) {
                        msgEl.querySelector('.text').textContent = "ğŸš« Admin deleted message";
                        bubble.classList.add('deleted-message');
                        bubble.classList.remove('ai-message');
                        if(msgEl.querySelector('.reply-quote-block')) msgEl.querySelector('.reply-quote-block').remove();
                        if(msgEl.querySelector('.admin-delete-btn')) msgEl.querySelector('.admin-delete-btn').remove();
                    }
                }
            });
        }

        function displayMessage(msgId, user, text, timestamp, senderId, isDeleted, replyToData) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper');
            wrapper.id = `msg-${msgId}`;

            const messageDiv = document.createElement('div');
            
            const isMyMessage = senderId ? (senderId === myUUID) : (user === username);
            const isBot = senderId === BOT_ID; 
            const lowerUser = user.toLowerCase().trim();
            const cleanMyName = username.toLowerCase().trim();
            
            // âœ… Badge Logic: Only EXACT MATCH gets verified badge
            const isNaimur = lowerUser === 'naimur rahman';
            
            // âœ… Strict Delete Power: Only 'Naimur Rahman' gets delete button
            const iAmAdmin = cleanMyName === 'naimur rahman';

            messageDiv.classList.add('message');
            if (isBot) {
                messageDiv.classList.add('other-message', 'ai-message');
            } else {
                messageDiv.classList.add(isMyMessage ? 'my-message' : 'other-message');
            }
            if (isNaimur && !isBot) messageDiv.classList.add('admin-special');
            if (isDeleted) messageDiv.classList.add('deleted-message');

            // --- SWIPE TO REPLY LOGIC (Mobile) ---
            if (!isDeleted) {
                let touchStartX = 0;
                let touchCurrentX = 0;
                const SWIPE_THRESHOLD = 50;

                messageDiv.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                }, {passive: true});

                messageDiv.addEventListener('touchmove', (e) => {
                    touchCurrentX = e.touches[0].clientX;
                    const diff = touchCurrentX - touchStartX;
                    
                    if (diff > 0 && diff < 150) { 
                        messageDiv.style.transform = `translateX(${diff}px)`;
                    }
                }, {passive: true});

                messageDiv.addEventListener('touchend', () => {
                    const diff = touchCurrentX - touchStartX;
                    if (diff > SWIPE_THRESHOLD) {
                        if(navigator.vibrate) navigator.vibrate(50);
                        initiateReply(msgId, user, text);
                    }
                    messageDiv.style.transform = 'translateX(0)';
                    touchStartX = 0;
                    touchCurrentX = 0;
                });
            }

            // Double Click Reply (Desktop) & Long Press
            if (!isDeleted) {
                messageDiv.addEventListener('dblclick', (e) => showReactionMenu(e, msgId, wrapper));
                let pressTimer;
                messageDiv.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => showReactionMenu(null, msgId, wrapper), 600);
                }, {passive: true});
                messageDiv.addEventListener('touchend', () => clearTimeout(pressTimer));
            }

            // Admin Delete
            if (iAmAdmin && !isDeleted) {
                const delBtn = document.createElement('button');
                delBtn.innerText = 'ğŸ—‘ï¸'; 
                delBtn.className = isMyMessage ? 'admin-delete-btn delete-left' : 'admin-delete-btn delete-right';
                
                // Stop bubbling to prevent interference with other events
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteMessage(msgId);
                };
                delBtn.ontouchstart = (e) => {
                    e.stopPropagation(); 
                };

                wrapper.appendChild(delBtn);
            }

            let timeStr = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";

            const metaDiv = document.createElement('div');
            metaDiv.classList.add('meta');
            
            if (isDeleted) {
                metaDiv.innerHTML = `Unknown â€¢ ${timeStr}`;
            } else {
                let nameHTML = isMyMessage ? 'You' : user;
                if (isNaimur && !isBot) {
                    nameHTML += ` <span class="verified-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12L11 14L15 10M12 3L13.9101 4.25465C14.616 4.71826 15.5286 4.71826 16.2345 4.25465L18.1446 3L18.8858 5.17418C19.1598 5.97794 19.8211 6.63919 20.6248 6.91322L22.799 7.65444L21.5443 9.56449C21.0807 10.2704 21.0807 11.183 21.5443 11.8889L22.799 13.7989L20.6248 14.5402C19.8211 14.8142 19.1598 15.4754 18.8858 16.2792L18.1446 18.4534L16.2345 17.1987C15.5286 16.7351 14.616 16.7351 13.9101 17.1987L12 18.4534L10.0899 17.1987C9.38396 16.7351 8.47135 16.7351 7.76543 17.1987L5.85538 18.4534L5.11417 16.2792C4.84015 15.4754 4.17889 14.8142 3.37513 14.5402L1.20096 13.7989L2.45561 11.8889C2.91923 11.183 2.91923 10.2704 2.45561 9.56449L1.20096 7.65444L3.37513 6.91322C4.17889 6.63919 4.84015 5.97794 5.11417 5.17418L5.85538 3L7.76543 4.25465C8.47135 4.71826 9.38396 4.71826 10.0899 4.25465L12 3Z"/></svg></span>`;
                }
                metaDiv.innerHTML = `${nameHTML} â€¢ ${timeStr}`;
            }

            if (replyToData) {
                const replyBlock = document.createElement('div');
                replyBlock.className = 'reply-quote-block';
                replyBlock.innerHTML = `
                    <div class="reply-quote-name">${replyToData.username}</div>
                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${replyToData.text}</div>
                `;
                replyBlock.onclick = () => {
                    const originalMsg = document.getElementById(`msg-${replyToData.id}`);
                    if(originalMsg) originalMsg.scrollIntoView({behavior: 'smooth', block: 'center'});
                };
                messageDiv.appendChild(replyBlock);
            }

            const textDiv = document.createElement('div');
            textDiv.classList.add('text');
            textDiv.textContent = text;

            messageDiv.appendChild(metaDiv);
            messageDiv.appendChild(textDiv);
            
            const reactionDisplay = document.createElement('div');
            reactionDisplay.id = `react-disp-${msgId}`;
            reactionDisplay.className = 'reaction-display-bubble hidden';

            wrapper.appendChild(messageDiv);
            wrapper.appendChild(reactionDisplay);
            wrapper.style.alignItems = isMyMessage ? 'flex-end' : 'flex-start';

            messagesContainer.appendChild(wrapper);
            if(!isDeleted) {
                database.ref(`messages/${msgId}/reactions`).once('value', (snap) => {
                    if(snap.exists()) updateReactions(msgId, snap.val());
                });
            }
        }

        function initiateReply(msgId, name, text) {
            currentReply = { id: msgId, username: name, text: text };
            replyToName.innerText = `Replying to ${name}`;
            replyTextDisplay.innerText = text;
            replyPreview.classList.remove('hidden');
            messageInput.focus();
        }

        function cancelReply() {
            currentReply = null;
            replyPreview.classList.add('hidden');
        }

        let currentOpenMenuId = null;

        function showReactionMenu(e, msgId, wrapper) {
            if(e) e.preventDefault(); 
            const existingMenu = document.getElementById('active-reaction-menu');
            if(existingMenu) existingMenu.remove();

            if (currentOpenMenuId === msgId) { currentOpenMenuId = null; return; }

            const menu = document.createElement('div');
            menu.id = 'active-reaction-menu';
            menu.className = 'reaction-menu';

            const replyBtn = document.createElement('div');
            replyBtn.innerHTML = '<i data-lucide="reply" style="width:16px;"></i>';
            replyBtn.className = 'reply-option-btn';
            replyBtn.onclick = () => {
                const msgEl = document.getElementById(`msg-${msgId}`);
                const textContent = msgEl.querySelector('.text').innerText;
                const nameContent = msgEl.querySelector('.meta').innerText.split('â€¢')[0].trim();
                initiateReply(msgId, nameContent, textContent);
                menu.remove();
                currentOpenMenuId = null;
            };
            menu.appendChild(replyBtn);

            // ADMIN PIN OPTION
            if(username.toLowerCase() === 'naimur rahman') {
                const pinBtn = document.createElement('div');
                pinBtn.innerHTML = '<i data-lucide="pin" style="width:16px;"></i>';
                pinBtn.className = 'pin-option-btn';
                pinBtn.style.marginLeft = '8px';
                pinBtn.onclick = () => {
                    const msgEl = document.getElementById(`msg-${msgId}`);
                    const textContent = msgEl.querySelector('.text').innerText;
                    const nameContent = msgEl.querySelector('.meta').innerText.split('â€¢')[0].trim();
                    pinMessage(msgId, textContent, nameContent);
                    menu.remove();
                    currentOpenMenuId = null;
                };
                menu.appendChild(pinBtn);
            }

            const sep = document.createElement('span');
            sep.style.borderLeft = '1px solid #ccc'; sep.style.margin = '0 5px';
            menu.appendChild(sep);

            REACTION_OPTIONS.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'reaction-option';
                span.textContent = emoji;
                span.onclick = () => submitReaction(msgId, emoji);
                menu.appendChild(span);
            });

            wrapper.appendChild(menu);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            currentOpenMenuId = msgId;

            setTimeout(() => { if(menu.parentNode) menu.remove(); currentOpenMenuId = null; }, 4000);
        }

        function submitReaction(msgId, emoji) {
            const existingMenu = document.getElementById('active-reaction-menu');
            if(existingMenu) existingMenu.remove();
            currentOpenMenuId = null;
            database.ref(`messages/${msgId}/reactions/${myUUID}`).set(emoji);
        }

        function updateReactions(msgId, reactionsData) {
            const display = document.getElementById(`react-disp-${msgId}`);
            if(!display) return;
            if (!reactionsData) { display.classList.add('hidden'); return; }

            const counts = {};
            Object.values(reactionsData).forEach(emoji => { counts[emoji] = (counts[emoji] || 0) + 1; });

            let html = '';
            Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([emoji, count]) => {
                html += `<span>${emoji} ${count > 1 ? count : ''}</span>`;
            });

            if (html === '') display.classList.add('hidden');
            else { display.innerHTML = html; display.classList.remove('hidden'); }
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.message') && !e.target.closest('.reaction-menu') && !e.target.closest('.admin-delete-btn')) {
                const existingMenu = document.getElementById('active-reaction-menu');
                if(existingMenu) { existingMenu.remove(); currentOpenMenuId = null; }
            }
        });

        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
    </script>
</body>
</html>
